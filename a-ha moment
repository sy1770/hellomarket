with signup_log as
(
  select
  signup_date.member_idx,
  signup_date.time,
  date_parse(td_time_format(signup_date.time, 'yyyyMMddHHmmss', 'KST'), '%Y%m%d%H%i%s') as signup_timestamp,
  case signup_platform.member_platform_type
    when '01' then 'iOS'
    when '02' then 'Android'
    when '10' then 'Web'
    when '11' then 'MobileWeb'
  end as platform,
  signup_agesex.age,
  case 
    when signup_agesex.age < 25 then '**-25'
    when signup_agesex.age >= 25 and signup_agesex.age < 35 then '25-34'
    when signup_agesex.age >= 35 and signup_agesex.age < 45 then '35-44'
    when signup_agesex.age >= 45 and signup_agesex.age < 55 then '45-54'
    when signup_agesex.age >= 55 then '55-**'
    else 'null_age'
  end as age_band, 
  if(LENGTH(signup_agesex.sex) <1 or signup_agesex.sex is null, 'null_sex', signup_agesex.sex) as gender
  -- coalesce(signup_agesex.sex, 'null_sex') as sex
  
  from hellomarket_3.member_signup_tbl as signup_date
    left join hellomarket_3.member_signup_platform_tbl as signup_platform on signup_date.member_idx = signup_platform.member_idx
    left join hellomarket.members_demography as signup_agesex on signup_date.member_idx = signup_agesex.member_idx
  
  where
   TD_TIME_RANGE(signup_date.time,'2023-02-27', '2023-03-06', 'KST')
   and signup_platform.member_platform_type in ('01', '02', '11', '10')
),

/*
signup_cnt as
(
  select TD_DATE_TRUNC('day', signup_log.time, 'KST') as signup_date, 
    platform, 
    sex, 
    age_band, 
    count(distinct member_idx) as signup_db_cnt
  from signup_log
  group by 1, 2, 3, 4
), */

visit_api_log as
(
  select time, url, date_parse(td_time_format(time, 'yyyyMMddHHmmss', 'KST'), '%Y%m%d%H%i%s') as log_timestamp, header_application_memberid as member_idx
  from hellomarket.api_log
  where td_time_range(time, '2023-04-15','2023-04-28', 'KST')
),

log_with_member_inform as
(
  select 
  visit_api_log.url,
  visit_api_log.time as log_time,
  visit_api_log.member_idx, 
  signup_log.time as signup_time,
  signup_log.platform, 
  signup_log.age, 
  signup_log.gender,
  date_diff('day', signup_log.signup_timestamp, visit_api_log.log_timestamp) days_gap
  from visit_api_log left join signup_log on visit_api_log.member_idx = signup_log.member_idx
  where date_diff('day', signup_log.signup_timestamp, visit_api_log.log_timestamp) >= 47
  and date_diff('day', signup_log.signup_timestamp, visit_api_log.log_timestamp) < 53  
)


select
DISTINCT member_idx, age, gender, platform,
-- td_time_format(min(log_time), 'yyyy-MM-dd HH:mm', 'KST') log_min_time, min(days_gap) max_gap,
-- td_time_format(max(log_time), 'yyyy-MM-dd HH:mm', 'KST') log_max_time, max(days_gap) max_gap,
td_time_format((signup_time), 'yyyy-MM-dd', 'KST') signup_time,


count(distinct td_time_format(log_time, 'yyyy-MM-dd', 'KST')) visit_days_cnt

from log_with_member_inform

group by 1, 2, 3, 4, 5
order by 6 desc, 2 asc

/*
select
td_time_format(time, 'yyyy-MM-dd HH:mm:ss', 'KST'),
url

from api_log

where
header_application_memberid = '5823979'
and td_time_range(time, '2023-03-04', null, 'KST')
order by 1 asc
*/
