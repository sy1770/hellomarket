select	left(escrow_item_tbl.regdate, 14) as regdate_datetime,
        left(escrow_item_tbl.editdate, 14) as editdate_datetime,
	escrow_tbl.escrow_idx,
        escrow_item_tbl.escrow_item_idx,
        escrow_item_tbl.escrow_status,
        escrow_tbl.escrow_seller_idx,
        escrow_tbl.escrow_buyer_idx,
        escrow_platform_tbl.escrow_platform_type,
        if(transaction_tbl.item_category_id is not null, transaction_tbl.item_category_id,
          if(escrow_item_tbl.editdate<20200201000000 or escrow_item_tbl.editdate>=20210401000000,
            (select item.item_category_id from item_tbl as item where item.item_idx = escrow_item_tbl.item_idx),NULL)) 
        as item_category_id,
        
        escrow_tbl.escrow_payment_method,
        (escrow_tbl.escrow_charge) as escrow_charge,
        (escrow_tbl.escrow_amount) as escrow_amount,
        (escrow_item_tbl.item_price) as item_price,
        -1*(escrow_tbl.escrow_wallet_amount) as wallet_amount,
        -1*(escrow_tbl.escrow_wallet_point) as point_amount,
        escrow_payment_finance_name,
        escrow_item_tbl.item_idx,

        dd.age as buyer_age,
        dd.gender as buyer_gender,
        dd.signup_date as buyer_signup_date,
        coupon.coupon_price,
        (select p.member_platform_type from member_platform_tbl p where p.member_idx = escrow_tbl.escrow_buyer_idx) as buyer_platform

from 	escrow_tbl 
            left join
            (
                select
                a.member_idx, a.age, a.gender, a.signup_date

                from
                (
                    select
                    member_tbl.member_idx,
                    year(now())-ifnull(ci_m.birth_year, kakao.birthyear) as age,
                    case ifnull(ci_m.sex_dream, ifnull(ci_m.sex_raon, ifnull(ci_m.iam_gender, kakao.gender)))
                    when '1' then 'M'
                    when '2' then 'F'
                    when 'male' then 'M'
                    when 'female' then 'F'
                    when 'M' then 'M'
                    when 'F' then 'F'
                    end as gender,
                    left(member_tbl.regdate, 8) as signup_date

                    from
                    member_tbl 
                        left join
                        (
                            select ci.member_idx, left(ci.member_birthday, 4) as birth_year, dream.member_sex as sex_dream, raon.member_sex as sex_raon, iamport.member_gender as iam_gender
                            from member_ci_tbl ci
                                    left join member_dreamsecurity_mobile_tbl dream on ci.member_idx = dream.member_idx and ci.member_ci = dream.member_ci
                                    left join member_raonsecure_card_tbl raon on ci.member_idx = raon.member_idx and ci.member_ci = raon.member_ci
                                    left join member_ci_iamport_tbl iamport on ci.member_idx = iamport.member_idx and ci.member_ci = iamport.member_ci
                            where ci.member_ci_type in ('10', '20') -- '10' 성인, '20' 미성년, '30' 보호자
                                    and length(ci.member_ci) > 0 -- 휴면으로 빠진 회원 정보 제외
                        ) ci_m using(member_idx)
                        left join member_ci_kakaosync_tbl kakao on member_tbl.member_idx = kakao.member_idx
                ) a
                group by 1 -- having a.age is not null
            ) dd on escrow_tbl.escrow_buyer_idx = dd.member_idx
            left join escrow_coupon_tbl as coupon using(escrow_idx),
        escrow_platform_tbl,
        escrow_item_tbl left join (
            select aaa.item_idx, aaa.item_category_id
            from hellomarket_analytics.transaction_item_tbl aaa
            where aaa.transaction_date >= DATE_FORMAT(DATE_SUB(NOW(),INTERVAL 40 month), '%Y%m%d000000')

            group by aaa.item_idx
            ) transaction_tbl on escrow_item_tbl.item_idx = transaction_tbl.item_idx
        

where 	escrow_tbl.escrow_idx=escrow_item_tbl.escrow_idx
        and escrow_tbl.escrow_idx = escrow_platform_tbl.escrow_idx
        and escrow_item_tbl.escrow_status ='FC'
