select	left(escrow_item_tbl.regdate, 14) as regdate_datetime,
        left(escrow_item_tbl.editdate, 14) as editdate_datetime,
	escrow_tbl.escrow_idx,
        escrow_item_tbl.escrow_item_idx,
        escrow_item_tbl.escrow_status,
        escrow_tbl.escrow_seller_idx,
        escrow_tbl.escrow_buyer_idx,
        escrow_platform_tbl.escrow_platform_type,
        if(transaction_tbl.item_category_id is not null, transaction_tbl.item_category_id,
          if(escrow_item_tbl.editdate<20200201000000 or escrow_item_tbl.editdate>=20210401000000,
            (select item.item_category_id from item_tbl as item where item.item_idx = escrow_item_tbl.item_idx),NULL)) 
        as item_category_id,
        
        escrow_tbl.escrow_payment_method,
        (escrow_tbl.escrow_charge) as escrow_charge,
        (escrow_tbl.escrow_amount) as escrow_amount,
        (escrow_item_tbl.item_price) as item_price,
        -1*(escrow_tbl.escrow_wallet_amount) as wallet_amount,
        -1*(escrow_tbl.escrow_wallet_point) as point_amount,
        escrow_payment_finance_name,
        escrow_item_tbl.item_idx

from 	escrow_tbl,
        escrow_platform_tbl, 
        escrow_item_tbl left join (
            select aaa.item_idx, aaa.item_category_id
            from hellomarket_analytics.transaction_item_tbl aaa
            where aaa.transaction_date >= DATE_FORMAT(DATE_SUB(NOW(),INTERVAL 40 month), '%Y%m%d000000')

            group by aaa.item_idx
            ) transaction_tbl on escrow_item_tbl.item_idx = transaction_tbl.item_idx
        

where 	escrow_tbl.escrow_idx=escrow_item_tbl.escrow_idx
        and escrow_tbl.escrow_idx = escrow_platform_tbl.escrow_idx
        and escrow_item_tbl.escrow_status ='FC'
