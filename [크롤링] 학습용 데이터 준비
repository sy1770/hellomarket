with
base_list as (
  select
    a.idx,
    brand,
    image_url,
    used_type,
    sell_state,
    title,
    description,
    category_id,
    category,
    price,
    brand_cnt.b_cnt
  from
    bunjang_market_price as a
      left join (select idx, count(distinct brand) as b_cnt from bunjang_market_price group by 1) as brand_cnt 
        on a.idx = brand_cnt.idx
  where
    substr(category_id, 1, 3) in ('310', '320')
    and not regexp_like(cast(price as VARCHAR), '1234|4321|111|777|555')
    and not regexp_like(title, '구매|구합니다|구해|삽니|매입')
),

multi_brand as (select * from base_list where b_cnt > 1),

unique_row_tbl as (
  select *
  from (select *, ROW_NUMBER() OVER(PARTITION BY idx order by brand) as rn from multi_brand)
  where rn = 1
),

brand_in_title_tbl as (
  select
    a.*,
    -- a.title,
    if(LENGTH(b.brand_crwl)=1, 
      if(CONTAINS(split(a.title, ' '), b.brand_crwl), -- 한 글자인 경우는 띄어쓰기 되어 있으면 브랜드값 유효
        b.brand_crwl, 
        null), 
      if(LENGTH(b.brand_crwl)=2,  -- 두 글자인 경우는 띄어쓰기 되어 있거나 맨 앞에 그 두 글자가 나타나면 브랜드값 유효
        if(SUBSTR(a.title, 1, 2) = b.brand_crwl or CONTAINS(split(a.title, ' '), b.brand_crwl), 
          b.brand_crwl, 
          null), 
        b.brand_crwl)) as brand_in_title  -- 세 글자 이상은 무조건 브랜드값 유효
  from unique_row_tbl as a left join brand_mapping b on a.title like concat('%',b.brand_crwl,'%')
)
,


brand_cnt_title as (
  select a.*
  from brand_in_title_tbl as a left join (select idx, count(distinct brand_in_title) as cnt_in_title from brand_in_title_tbl group by 1) as b
    on a.idx = b.idx
  where b.cnt_in_title = 1
  and a.brand_in_title is not null
)

select
  c.idx,
  c.image_url,
  bm.brand_idx_resell,
  bm.brand_korean,
  cm.category_idx_resell,
  c.used_type,
  c.sell_state,
  c.title,
  c.description,
  c.price


from brand_cnt_title as c
  left join brand_mapping as bm on c.brand_in_title = bm.brand_crwl
  left join category_mapping_bj_to_resell as cm on c.category = cm.bj_3_name and substr(c.category_id, 1, 6) = cm.bj_2_code



